<%# partials/_profileDetails.ejs %>

<div class="w-full max-w-2xl mx-auto md:mx-0 px-5 mt-4 bg-gray-200 rounded-md shadow ">
    <div id="profile-view">
        <div class="relative h-24 bg-gray-50 rounded-md">
            <div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2">
                <div class="relative">
                    <%
                        const profileImageUrl = (user.profileImage && user.profileImage.length > 0)
                            ? user.profileImage
                            : '/images/profilePic.jpeg';
                    %>
                    <img
                        id="profile-image-preview"
                        src="<%= profileImageUrl %>"
                        alt="Profile"
                        class="w-24 h-24 rounded-full border-2 border-gray-700 object-cover"
                    />
                    
                    <div class="absolute bottom-0 right-0 bg-white p-1 rounded-full shadow-md">
                        <label for="profile-picture-input" class="cursor-pointer">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 text-gray-700"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-14 pb-4">
            <div class="space-y-4">
                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                    <div class="p-2 bg-gray-50 rounded-lg mr-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 text-gray-400"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                clip-rule="evenodd"
                            />
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-black">Full Name</p>
                        <p class="font-medium text-black"><%= user.firstname %> <%= user.lastname %></p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                    <div class="p-2 bg-gray-50 rounded-lg mr-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 text-gray-400"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                            />
                            <path
                                d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                            />
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-black">Email</p>
                        <p class="font-medium text-black"><%= user.email %></p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                    <div class="p-2 bg-gray-50 rounded-lg mr-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 text-gray-400"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
                            />
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-black">Mobile</p>
                        <p class="font-medium text-black"><%= user.mobile %></p>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                    <div class="p-2 bg-gray-50 rounded-lg mr-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 text-gray-400"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                clip-rule="evenodd"
                            />
                        </svg>
                    </div>
                    <div>
                        <% if (address && address.length > 0) { %>
                            <p class="text-xs text-black">Address</p>
                            <p class="font-medium text-black"><%= address[0].name %></p>
                        <% } else { %>
                            <p class="text-xs text-black">No default address set.</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-center">
                <button
                onclick="openEditProfileModal()"
                    id="btn-edit-profile"
                    class="px-6 py-2 bg-gray-50 text-black rounded-lg flex items-center hover:bg-gray-300  transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-2"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
                        />
                    </svg>
                    Edit Profile
                </button>
            </div>
            <div id="profile-message" class="mt-4 text-center text-sm font-semibold"></div>
        </div>
    </div>
</div>

<div id="editProfileModal" class="fixed inset-0 bg-gray-50 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-200 text-white rounded-2xl shadow-2xl w-full  max-w-lg px-4 pb-1 relative animate-fadeIn">
        <button  onclick="closeModal()" id="btn-close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <form id="profile-update-form" enctype="multipart/form-data">
            <div class="flex flex-col items-center mb-1">
                <div class="relative w-28 h-28 mb-1 rounded-full overflow-hidden border-2 border-gray-600">
                    <img
                        id="profile-modal-image-preview"
                        src="<%= profileImageUrl %>"
                        alt="Profile"
                        class="w-full h-full object-cover"
                    />
                </div>
                <input type="file" id="profile-picture-input" name="profileImage" accept="image/*" class="hidden">
                <label for="profile-picture-input" class="bg-black text-white text-xs px-3 py-1.5 rounded-md cursor-pointer hover:bg-blue-700 transition">
                    Change Photo
                </label>
                <span id="upload-status" class="text-xs text-gray-500 mt-1"></span>
            </div>

            <div class="mb-1">
                <label for="fullName" class="block text-sm font-medium text-gray-900">Full Name</label>
                <div class="relative">
                    <svg class="h-5 w-5 text-gray-500 absolute left-3 top-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                    <input required type="text" id="fullName" name="fullName" class="w-full border border-gray-600 rounded-lg bg-gray-80 text-black p-2 pl-10" value="<%= user.firstname + ' ' + user.lastname %>">
                </div>
            </div>

            <div class="mb-1 ">
                <label for="email" class="block text-sm  font-medium text-gray-900">Email</label>
                <div class="relative ">
                    <svg class="h-5 w-5 text-gray-900 absolute left-3 top-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                    <input required type="email" id="email" name="email" class="w-full border  border-gray-600 rounded-lg bg-gray-80 text-black p-2 pl-10" value="<%= user.email %>">
                    <input type="hidden" name="originalEmail" value="<%= user.email %>">
                </div>
            </div>

            <div class="mb-1">
                <label for="mobile" class="block text-sm font-medium text-gray-900">Mobile</label>
                <div class="relative">
                    <svg class="h-5 w-5 text-gray-500 absolute left-3 top-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
                    <input required name="phone" type="text" id="mobile" class="w-full border border-gray-600 rounded-lg bg-gray-80 text-black p-2 pl-10" value="<%= user.mobile %>">
                </div>
            </div>

            <div class="mb-1">
                <label class="block text-sm font-medium text-gray-900">Address</label>
                <input type="hidden" id="allAddresses" value='<%- JSON.stringify(address) %>'>
                <div class="flex items-center gap-2">
                    <div class="relative pl-10 border border-gray-600 rounded-lg p-2 flex-1 bg-gray-80 text-black flex items-center">
                        <svg class="h-5 w-5 text-gray-900 absolute left-3 top-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                        <span id="addressSpan">
                            <%= address && address.length ? address[0].name : "No Address set" %>
                        </span>
                        <input type="hidden" name="addressId" id="addressId" value='<%= address && address.length ? address[0]._id : '' %>'>
                    </div>
                    <% if (address && address.length) { %>
                        <select id="addressSelect" class="border border-gray-600 rounded-lg bg-gray-80 text-black p-2">
                            <% address.forEach((address, index) => { %>
                                <option value="<%= address._id %>" <% if (index === 0) { %>selected<% } %>><%= address.name %></option>
                            <% }) %>
                        </select>
                    <% } else { %>
                        <a href="/profile/address"><span class="text-sm text-black bg-gray-80 border border-gray-600 rounded-lg px-3 py-1">Add new+</span></a>
                    <% } %>
                </div>
            </div>

            <div class="flex justify-end mt-1">
                <button id="save-btn" type="submit" class="px-4 py-1 bg-gray-80 text-black rounded-lg hover:bg-gray-300 transition">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    // These functions are defined globally so they can be called by the `onclick` attribute
    function openEditProfileModal() {
        const editProfileModal = document.getElementById('editProfileModal');
        const profileModalImagePreview = document.getElementById('profile-modal-image-preview');
        const profileImageStatic = document.getElementById('profile-image-preview');
        
        if (editProfileModal) {
            editProfileModal.classList.remove('hidden');
        }
        
        if (profileImageStatic && profileModalImagePreview) {
            profileModalImagePreview.src = profileImageStatic.src;
        }
    }

    function closeModal() {
        const editProfileModal = document.getElementById('editProfileModal');
        if (editProfileModal) {
            editProfileModal.classList.add('hidden');
        }
    }

    // All other logic that doesn't use the `onclick` attribute should be in here
    document.addEventListener('DOMContentLoaded', () => {
        const editProfileModal = document.getElementById('editProfileModal');
        const profilePictureInput = document.getElementById('profile-picture-input');
        const profileModalImagePreview = document.getElementById('profile-modal-image-preview');
        const addressSelect = document.getElementById('addressSelect');
        const addressSpan = document.getElementById('addressSpan');
        const addressIdInput = document.getElementById('addressId');

        // Close modal when clicking outside of it
        if (editProfileModal) {
            editProfileModal.addEventListener('click', (event) => {
                // If the click target is the modal's outer background, close it
                if (event.target === editProfileModal) {
                    closeModal();
                }
            });
        }
        
        // --- Address and Image Preview Logic ---
        
        let allAddresses = [];
        const allAddressesElement = document.getElementById('allAddresses');
        if (allAddressesElement) {
            try {
                allAddresses = JSON.parse(allAddressesElement.value);
            } catch (e) {
                console.error('Failed to parse addresses JSON:', e);
            }
        }

        if (addressSelect && allAddresses.length > 0) {
            addressSelect.addEventListener('change', (event) => {
                const selectedAddressId = event.target.value;
                const selectedAddress = allAddresses.find(addr => addr._id === selectedAddressId);
                if (selectedAddress) {
                    addressSpan.textContent = selectedAddress.name;
                    addressIdInput.value = selectedAddress._id;
                }
            });
        }
        
        if (profilePictureInput && profileModalImagePreview) {
            profilePictureInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        profileModalImagePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>