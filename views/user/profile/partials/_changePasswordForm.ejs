<%# views/user/profile/partials/_changePasswordForm.ejs %>
<div class="max-w-md mx-auto md:mx-0 p-1 sm:p-6 bg-white rounded-lg shadow-md text-gray-900">
    <h2 class="text-2xl font-bold mb-6 text-gray-900 border-b border-gray-200 pb-3">Change Password</h2>
    <form id="changePasswordForm" class="space-y-1">
        <div>
            <label for="currentPassword" class="block text-sm font-medium text-gray-700">Current Password</label>
            <input type="password" id="currentPassword" name="currentPassword" required
                   class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900">
        </div>
        <div>
            <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
            <input type="password" id="newPassword" name="newPassword" required
                   class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900">
        </div>
        <div>
            <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required
                   class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900">
        </div>
        <div id="passwordMessage" class="text-center text-sm"></div>
        <div class="text-center">
            <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700">
                Update Password
            </button>
        </div>
    </form>
</div>

<%# Client-side JavaScript for handling password change form submission %>
<script>
    document.getElementById('changePasswordForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const form = event.target;
        const currentPassword = form.currentPassword.value;
        const newPassword = form.newPassword.value;
        const confirmPassword = form.confirmPassword.value;
        const messageDiv = document.getElementById('passwordMessage');

        // Clear previous messages and errors
        messageDiv.textContent = '';
        messageDiv.className = 'text-center text-sm font-semibold mt-4'; // Reset classes
        document.getElementById('currentPasswordError').textContent = '';
        document.getElementById('newPasswordError').textContent = '';
        document.getElementById('confirmPasswordError').textContent = '';

        let isValid = true;

        // Client-side Validation Checks
        if (newPassword.length < 8) {
            document.getElementById('newPasswordError').textContent = 'New password must be at least 8 characters long.';
            isValid = false;
        }
        if (!/[A-Z]/.test(newPassword)) {
            document.getElementById('newPasswordError').textContent = 'New password must contain at least one uppercase letter.';
            isValid = false;
        }
        if (!/[a-z]/.test(newPassword)) {
            document.getElementById('newPasswordError').textContent = 'New password must contain at least one lowercase letter.';
            isValid = false;
        }
        if (!/[0-9]/.test(newPassword)) {
            document.getElementById('newPasswordError').textContent = 'New password must contain at least one number.';
            isValid = false;
        }
        if (!/[^A-Za-z0-9]/.test(newPassword)) {
            document.getElementById('newPasswordError').textContent = 'New password must contain at least one special character.';
            isValid = false;
        }
        if (newPassword !== confirmPassword) {
            document.getElementById('confirmPasswordError').textContent = 'New password and confirm password do not match.';
            isValid = false;
        }
        if (newPassword === currentPassword && newPassword.length > 0) { // Check if new password is same as current (only if not empty)
            document.getElementById('newPasswordError').textContent = 'New password cannot be the same as current password.';
            isValid = false;
        }

        if (!isValid) {
            messageDiv.className = 'text-center text-red-500 text-sm font-semibold mt-4';
            messageDiv.textContent = 'Please fix the errors above.';
            return;
        }

        try {
            const response = await fetch('/user/profile/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ currentPassword, newPassword, confirmPassword }) // Send confirmPassword too
            });

            const result = await response.json(); // EXPECT JSON RESPONSE from controller

            if (result.success) { // Check for 'success' property in JSON
                messageDiv.className = 'text-center text-green-500 text-sm font-semibold mt-4';
                form.reset(); // Clear form on success
            } else {
                messageDiv.className = 'text-center text-red-500 text-sm font-semibold mt-4';
                // Display specific errors for current/new/confirm password if provided by backend
                if (result.errors) {
                    if (result.errors.currentPassword) document.getElementById('currentPasswordError').textContent = result.errors.currentPassword;
                    if (result.errors.newPassword) document.getElementById('newPasswordError').textContent = result.errors.newPassword;
                    if (result.errors.confirmPassword) document.getElementById('confirmPasswordError').textContent = result.errors.confirmPassword;
                }
            }
            messageDiv.textContent = result.message || 'An unexpected error occurred.'; // Display message from backend

        } catch (error) {
            console.error('Error changing password:', error);
            messageDiv.className = 'text-center text-red-500 text-sm font-semibold mt-4';
            messageDiv.textContent = 'A network error occurred. Please try again.';
        }
    });
</script>